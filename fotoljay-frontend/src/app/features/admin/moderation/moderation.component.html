<app-sidebar></app-sidebar>

<div class="moderation-container">
  <div class="header">
    <h1>üéØ Mod√©ration Centralis√©e</h1>
    <p>G√©rez efficacement les produits en attente de validation</p>
  </div>

  <!-- Filtres et statistiques -->
  <div class="moderation-controls">
    <div class="filters-section">
      <div class="filter-group">
        <label><i class="fas fa-filter"></i> Cat√©gorie:</label>
        <select [(ngModel)]="selectedCategory" (change)="applyFilters()" class="filter-select">
          <option value="">Toutes les cat√©gories</option>
          <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
        </select>
      </div>

      <div class="filter-group">
        <label><i class="fas fa-clock"></i> Tri:</label>
        <select [(ngModel)]="sortOrder" (change)="applyFilters()" class="filter-select">
          <option value="date-desc">Plus r√©cent</option>
          <option value="date-asc">Plus ancien</option>
          <option value="price-desc">Prix d√©croissant</option>
          <option value="price-asc">Prix croissant</option>
        </select>
      </div>
    </div>

    <div class="stats-section">
      <div class="stat-item">
        <i class="fas fa-box"></i>
        <span>{{ pendingProducts.length }} en attente</span>
      </div>
      <div class="stat-item">
        <i class="fas fa-clock"></i>
        <span>{{ avgModerationTime }}ms moyen</span>
      </div>
      <div class="stat-item">
        <i class="fas fa-chart-pie"></i>
        <span>{{ rejectionRate }}% refus</span>
      </div>
    </div>
  </div>

  <!-- Section statistiques d√©taill√©es -->
  <div class="stats-dashboard" *ngIf="moderationStats">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-tachometer-alt"></i>
        </div>
        <div class="stat-content">
          <h4>Temps Moyen</h4>
          <p class="stat-value">{{ moderationStats.avgTime }}ms</p>
          <span class="stat-trend positive">‚ÜóÔ∏è +5%</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-tags"></i>
        </div>
        <div class="stat-content">
          <h4>Cat√©gorie la plus active</h4>
          <p class="stat-value">{{ moderationStats.topCategory || 'N/A' }}</p>
          <span class="stat-count">{{ moderationStats.topCategoryCount || 0 }} produits</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-times-circle"></i>
        </div>
        <div class="stat-content">
          <h4>Taux de refus</h4>
          <p class="stat-value">{{ moderationStats.rejectionRate }}%</p>
          <span class="stat-trend negative">‚ÜóÔ∏è +2%</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-calendar-week"></i>
        </div>
        <div class="stat-content">
          <h4>Cette semaine</h4>
          <p class="stat-value">{{ moderationStats.weeklyModerated }}</p>
          <span class="stat-label">mod√©r√©s</span>
        </div>
      </div>
    </div>

    <!-- Graphique de r√©partition par cat√©gorie -->
    <div class="category-chart" *ngIf="moderationStats.categoryBreakdown && moderationStats.categoryBreakdown.length > 0">
      <h4><i class="fas fa-chart-bar"></i> R√©partition par cat√©gorie</h4>
      <div class="chart-container">
        <div class="chart-bar" *ngFor="let category of moderationStats.categoryBreakdown">
          <div class="bar-label">{{ category.name }}</div>
          <div class="bar-container">
            <div
              class="bar-fill"
              [style.width.%]="(category.count / moderationStats.totalModerated) * 100"
            ></div>
          </div>
          <div class="bar-value">{{ category.count }}</div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Chargement des produits en attente...</p>
  </div>

  <div *ngIf="!loading && !error" class="products-grid">
    <div *ngIf="filteredProducts.length === 0" class="empty-state">
      <div class="empty-icon">‚úÖ</div>
      <h3>Aucun produit trouv√©</h3>
      <p *ngIf="pendingProducts.length === 0">Tous les produits ont √©t√© mod√©r√©s</p>
      <p *ngIf="pendingProducts.length > 0">Aucun produit ne correspond aux filtres</p>
    </div>

    <div *ngFor="let product of filteredProducts" class="product-card" [class.selected]="selectedProduct?.id === product.id">
      <div class="product-header">
        <div class="product-info">
          <h3>{{ product.titre }}</h3>
          <p class="product-meta">
            <i class="fas fa-user"></i> {{ product.vendeurNom }} ‚Ä¢
            <i class="fas fa-phone"></i> {{ product.vendeurTelephone }} ‚Ä¢
            <i class="fas fa-tag"></i> {{ product.categorie }} ‚Ä¢
            <i class="fas fa-coins"></i> {{ product.prix }} FCFA
          </p>
          <p class="product-description">{{ product.description }}</p>
          <p class="product-date">
            <i class="fas fa-calendar"></i> {{ product.dateCreation | date:'short' }}
          </p>
        </div>
        <div class="product-status">
          <span class="status-badge status-pending">
            <i class="fas fa-clock"></i> En attente
          </span>
        </div>
      </div>

      <div class="product-images" *ngIf="product.images && product.images.length > 0">
        <div class="images-grid">
          <div
            *ngFor="let image of product.images; let i = index"
            class="image-container"
            (click)="openDetailedModal(product, i)"
          >
            <img
              [src]="getImageUrl(image)"
              [alt]="product.titre"
              class="product-image"
            />
            <div class="image-overlay">
              <i class="fas fa-search-plus"></i>
            </div>
          </div>
        </div>
      </div>

      <div class="product-actions">
        <button
          class="btn btn-success"
          (click)="approveProduct(product.id)"
          [disabled]="moderatingProductId === product.id"
          title="Approuver le produit"
        >
          <i class="fas fa-check"></i>
          <span>Approuver</span>
        </button>

        <button
          class="btn btn-warning"
          (click)="openRejectModal(product)"
          [disabled]="moderatingProductId === product.id"
          title="Rejeter avec raison"
        >
          <i class="fas fa-times"></i>
          <span>Rejeter</span>
        </button>

        <button
          class="btn btn-info"
          (click)="openDetailedModal(product, 0)"
          title="R√©vision d√©taill√©e"
        >
          <i class="fas fa-search"></i>
          <span>D√©taill√©</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de rejet -->
<div *ngIf="showRejectModal" class="reject-modal-overlay" (click)="closeRejectModal()">
  <div class="reject-modal" (click)="$event.stopPropagation()">
    <div class="reject-modal-header">
      <i class="fas fa-times-circle reject-icon"></i>
      <h3>Motif de rejet</h3>
    </div>

    <div class="reject-modal-body">
      <p><strong>Produit:</strong> {{ productToReject?.titre }}</p>
      <p><strong>Vendeur:</strong> {{ productToReject?.vendeurNom }}</p>

      <div class="reason-section">
        <label>Raison du rejet (obligatoire):</label>
        <select [(ngModel)]="rejectReason" class="reason-select">
          <option value="">S√©lectionner une raison</option>
          <option value="Qualit√© photo insuffisante">üì∏ Qualit√© photo insuffisante</option>
          <option value="Produit non conforme">üö´ Produit non conforme</option>
          <option value="Informations manquantes">üìù Informations manquantes</option>
          <option value="Contenu inappropri√©">‚ö†Ô∏è Contenu inappropri√©</option>
          <option value="Prix incorrect">üí∞ Prix incorrect</option>
          <option value="Cat√©gorie incorrecte">üè∑Ô∏è Cat√©gorie incorrecte</option>
        </select>
      </div>
    </div>

    <div class="reject-modal-actions">
      <button class="btn-cancel" (click)="closeRejectModal()">
        <i class="fas fa-times"></i> Annuler
      </button>
      <button class="btn-reject" (click)="confirmReject()" [disabled]="!rejectReason">
        <i class="fas fa-times"></i> Rejeter
      </button>
    </div>
  </div>
</div>

<!-- Modal de r√©vision d√©taill√©e -->
<div *ngIf="showDetailedModal" class="detailed-modal-overlay" (click)="closeDetailedModal()">
  <div class="detailed-modal" (click)="$event.stopPropagation()">
    <div class="detailed-modal-header">
      <div class="product-info">
        <h3>{{ detailedProduct?.titre }}</h3>
        <p><i class="fas fa-user"></i> {{ detailedProduct?.vendeurNom }} ‚Ä¢ <i class="fas fa-tag"></i> {{ detailedProduct?.categorie }}</p>
      </div>
      <button class="modal-close" (click)="closeDetailedModal()" title="Fermer">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="detailed-modal-body">
      <!-- Galerie d'images -->
      <div class="image-gallery" *ngIf="detailedProduct && detailedProduct.images && detailedProduct.images.length > 0">
        <div class="main-image-container">
          <button class="nav-btn prev-btn" (click)="prevImage()" [disabled]="currentImageIndex === 0">
            <i class="fas fa-chevron-left"></i>
          </button>

          <div class="main-image">
            <img [src]="getImageUrl(detailedProduct.images[currentImageIndex])" [alt]="detailedProduct.titre" />
            <div class="image-counter">{{ currentImageIndex + 1 }} / {{ detailedProduct.images.length }}</div>
          </div>

          <button class="nav-btn next-btn" (click)="nextImage()" [disabled]="currentImageIndex === detailedProduct.images.length - 1">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>

        <div class="thumbnail-strip" *ngIf="detailedProduct.images.length > 1">
          <div
            *ngFor="let image of detailedProduct.images; let i = index"
            class="thumbnail"
            [class.active]="i === currentImageIndex"
            (click)="currentImageIndex = i"
          >
            <img [src]="getImageUrl(image)" [alt]="detailedProduct.titre" />
          </div>
        </div>
      </div>

      <!-- Informations d√©taill√©es -->
      <div class="product-details">
        <div class="detail-section">
          <h4><i class="fas fa-info-circle"></i> Description</h4>
          <p>{{ detailedProduct?.description }}</p>
        </div>

        <div class="detail-section">
          <h4><i class="fas fa-coins"></i> Prix et √âtat</h4>
          <p><strong>Prix:</strong> {{ detailedProduct?.prix }} FCFA</p>
          <p><strong>√âtat:</strong> {{ detailedProduct?.etat }}</p>
        </div>

        <div class="detail-section">
          <h4><i class="fas fa-calendar"></i> Historique</h4>
          <p><strong>Publi√© le:</strong> {{ detailedProduct?.dateCreation | date:'medium' }}</p>
          <p><strong>Contact:</strong> {{ detailedProduct?.vendeurTelephone }}</p>
        </div>
      </div>
    </div>

    <div class="detailed-modal-actions">
      <button class="btn-approve" (click)="approveProduct(detailedProduct!.id); closeDetailedModal()">
        <i class="fas fa-check"></i> Approuver
      </button>
      <button class="btn-reject" (click)="openRejectModal(detailedProduct!); closeDetailedModal()">
        <i class="fas fa-times"></i> Rejeter
      </button>
    </div>
  </div>
</div>

<!-- Modal pour voir les images en grand (legacy) -->
<div *ngIf="selectedImage" class="image-modal" (click)="closeImageModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeImageModal()" title="Fermer"><i class="fas fa-times"></i></button>
    <img [src]="getImageUrl(selectedImage)" [alt]="selectedImage" class="modal-image" />
  </div>
</div>