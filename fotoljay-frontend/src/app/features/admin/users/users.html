<app-admin-header></app-admin-header>

<div class="moderation-container">
  <div class="header">
    <h1>üë§ Gestion des Utilisateurs</h1>
    <p>Administration compl√®te des comptes utilisateurs</p>
  </div>

  <!-- Vue d'ensemble - Statistiques -->
  <div class="overview-stats" *ngIf="userStats">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon users-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h4>Total Utilisateurs</h4>
          <p class="stat-value">{{ userStats.totalUsers }}</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon active-users-icon">
          <i class="fas fa-user-check"></i>
        </div>
        <div class="stat-content">
          <h4>Utilisateurs Actifs</h4>
          <p class="stat-value">{{ userStats.activeUsers }}</p>
          <span class="stat-label">(30 derniers jours)</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon vip-users-icon">
          <i class="fas fa-star"></i>
        </div>
        <div class="stat-content">
          <h4>Utilisateurs VIP</h4>
          <p class="stat-value">{{ userStats.vipUsers }}</p>
          <span class="stat-label">{{ userStats.vipPercentage }}%</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon retention-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-content">
          <h4>Taux de R√©tention</h4>
          <p class="stat-value">{{ userStats.retentionRate }}%</p>
          <span class="stat-trend positive">‚ÜóÔ∏è +3%</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtres et recherche -->
  <div class="filters-section">
    <div class="search-group">
      <i class="fas fa-search"></i>
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
        placeholder="Rechercher par nom, email, t√©l√©phone..."
        class="search-input"
      />
    </div>

    <div class="filter-group">
      <label><i class="fas fa-filter"></i> R√¥le:</label>
      <select [(ngModel)]="selectedRole" (change)="applyFilters()" class="filter-select">
        <option value="">Tous les r√¥les</option>
        <option value="UTILISATEUR">Utilisateur</option>
        <option value="VIP">VIP</option>
        <option value="MODERATEUR">Mod√©rateur</option>
        <option value="ADMINISTRATEUR">Administrateur</option>
      </select>
    </div>

    <div class="filter-group">
      <label><i class="fas fa-user-tag"></i> Statut:</label>
      <select [(ngModel)]="selectedStatus" (change)="applyFilters()" class="filter-select">
        <option value="">Tous les statuts</option>
        <option value="ACTIF">Actif</option>
        <option value="SUSPENDU">Suspendu</option>
        <option value="BLOQUE">Bloqu√©</option>
      </select>
    </div>

    <div class="filter-group">
      <label><i class="fas fa-sort"></i> Tri:</label>
      <select [(ngModel)]="sortBy" (change)="applyFilters()" class="filter-select">
        <option value="date-desc">Date inscription ‚Üì</option>
        <option value="date-asc">Date inscription ‚Üë</option>
        <option value="products-desc">Produits ‚Üì</option>
        <option value="products-asc">Produits ‚Üë</option>
        <option value="name-asc">Nom A-Z</option>
        <option value="name-desc">Nom Z-A</option>
      </select>
    </div>
  </div>

  <!-- Chargement -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Chargement des utilisateurs...</p>
  </div>

  <!-- Liste des utilisateurs -->
  <div *ngIf="!loading && !error" class="products-grid">
    <div *ngIf="users.length === 0" class="empty-state">
      <div class="empty-icon">üë•</div>
      <h3>Aucun utilisateur trouv√©</h3>
      <p *ngIf="searchTerm || selectedRole || selectedStatus">Aucun r√©sultat pour ces crit√®res de recherche</p>
      <p *ngIf="!searchTerm && !selectedRole && !selectedStatus">La plateforme n'a pas encore d'utilisateurs</p>
    </div>

    <div *ngFor="let user of users" class="product-card" [class.vip-user]="user.role === 'VIP'">
      <div class="product-header">
        <div class="product-info">
          <h3>
            {{ user.nom }}
            <span *ngIf="user.role === 'VIP'" class="vip-badge">‚≠ê</span>
          </h3>
          <p class="product-meta">
            <i class="fas fa-envelope"></i> {{ user.email }} ‚Ä¢
            <i class="fas fa-phone"></i> {{ user.telephone }} ‚Ä¢
            <i class="fas fa-box"></i> {{ user.productsCount || 0 }} produits
          </p>
          <p class="product-description">
            <strong>R√¥le:</strong>
            <span [ngClass]="getRoleClass(user.role)">{{ user.role }}</span><br>
            <strong>Statut:</strong>
            <span [ngClass]="getStatusClass(user.status)">{{ user.status }}</span><br>
            <strong>Inscription:</strong> {{ user.createdAt | date:'medium' }}
          </p>
        </div>
        <div class="product-status">
          <span class="status-badge" [ngClass]="getStatusClass(user.status)">
            {{ user.status }}
          </span>
        </div>
      </div>

      <!-- Actions -->
      <div class="product-actions">
        <button
          class="btn btn-info"
          (click)="viewUserDetails(user)"
          title="Voir les d√©tails"
        >
          <i class="fas fa-eye"></i>
          <span>D√©tails</span>
        </button>

        <select
          [value]="user.status"
          (change)="updateUserStatus(user.id, $any($event.target).value)"
          class="status-select"
        >
          <option value="ACTIF">Actif</option>
          <option value="SUSPENDU">Suspendu</option>
          <option value="BLOQUE">Bloqu√©</option>
        </select>

        <button
          class="btn btn-notification"
          (click)="sendNotification(user)"
          title="Envoyer une notification"
        >
          <i class="fas fa-bell"></i>
        </button>

        <button
          class="btn btn-delete"
          (click)="deleteUser(user)"
          title="Supprimer l'utilisateur"
        >
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination" *ngIf="total > limit">
    <button
      (click)="onPageChange(page - 1)"
      [disabled]="page <= 1"
      class="btn-page"
    >
      <i class="fas fa-chevron-left"></i> Pr√©c√©dent
    </button>

    <div class="page-info">
      <span>Page {{ page }} sur {{ totalPages }}</span>
      <span class="total-count">({{ total }} utilisateurs)</span>
    </div>

    <button
      (click)="onPageChange(page + 1)"
      [disabled]="page >= totalPages"
      class="btn-page"
    >
      Suivant <i class="fas fa-chevron-right"></i>
    </button>
  </div>
</div>

<!-- Modal d√©tails utilisateur -->
<div *ngIf="selectedUser" class="user-details-modal" (click)="closeUserModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fas fa-user"></i> D√©tails de {{ selectedUser.nom }}</h3>
      <button class="modal-close" (click)="closeUserModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="user-info-section">
        <h4><i class="fas fa-id-card"></i> Informations personnelles</h4>
        <div class="info-grid">
          <div class="info-item">
            <label>Nom complet:</label>
            <span>{{ selectedUser.nom }}</span>
          </div>
          <div class="info-item">
            <label>Email:</label>
            <span>{{ selectedUser.email }}</span>
          </div>
          <div class="info-item">
            <label>T√©l√©phone:</label>
            <span>{{ selectedUser.telephone }}</span>
          </div>
          <div class="info-item">
            <label>R√¥le:</label>
            <span [ngClass]="getRoleClass(selectedUser.role)">{{ selectedUser.role }}</span>
          </div>
          <div class="info-item">
            <label>Statut:</label>
            <span [ngClass]="getStatusClass(selectedUser.status)">{{ selectedUser.status }}</span>
          </div>
          <div class="info-item">
            <label>Date d'inscription:</label>
            <span>{{ selectedUser.createdAt | date:'medium' }}</span>
          </div>
        </div>
      </div>

      <div class="user-stats-section">
        <h4><i class="fas fa-chart-bar"></i> Statistiques</h4>
        <div class="stats-grid">
          <div class="stat-item">
            <i class="fas fa-box"></i>
            <span>{{ selectedUser.productsCount || 0 }} produits publi√©s</span>
          </div>
          <div class="stat-item">
            <i class="fas fa-eye"></i>
            <span>245 vues totales</span>
          </div>
          <div class="stat-item">
            <i class="fas fa-handshake"></i>
            <span>12 contacts</span>
          </div>
          <div class="stat-item">
            <i class="fas fa-star"></i>
            <span>4.2/5 moyenne</span>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-warning" (click)="resetPassword(selectedUser)">
        <i class="fas fa-key"></i> R√©initialiser MDP
      </button>
      <button class="btn btn-info" (click)="sendMessage(selectedUser)">
        <i class="fas fa-envelope"></i> Envoyer message
      </button>
      <button class="btn btn-danger" (click)="deleteUser(selectedUser)">
        <i class="fas fa-trash"></i> Supprimer compte
      </button>
    </div>
  </div>
</div>
